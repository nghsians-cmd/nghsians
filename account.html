<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NGHSIANS â€” Account</title>
<link rel="icon" href="favLogo.ico">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  :root{
    --bg: #050505;
    --panel: #0d0e10;
    --text: #eef0f2;
    --muted: #9aa0a6;
    --accent-deep: #710C04;
    --accent-gold: 255,243,154; 
    --font-sans: "Inter", system-ui, -apple-system, sans-serif;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--font-sans);overflow-x:hidden;}
  
  /* Background */
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><filter id='n'><feTurbulence baseFrequency='0.9' numOctaves='2' stitchTiles='stitch' seed='2'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0.055'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='0.08' /></svg>");
    opacity:0.15; mix-blend-mode:overlay;
  }

  /* Safety for Confetti Canvas - ensures it never blocks clicks */
  canvas { pointer-events: none !important; }

  /* UPDATED: Wrap now handles scrolling properly on mobile */
  .wrap {
    min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
    position: relative; z-index: 1;
  }

  /* --- AUTH CARD (Login/Signup/Forgot) --- */
  .auth-card {
    width: 100%; max-width: 450px;
    background: rgba(20, 20, 22, 0.6);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 40px;
    backdrop-filter: blur(12px);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    text-align: center; position: relative; overflow: hidden;
    transition: all 0.3s ease;
    z-index: 10;
  }
  .auth-card::before {
    content: ""; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, transparent, rgba(var(--accent-gold), 0.8), transparent);
  }

  /* --- DASHBOARD LAYOUT (Profile + Network) --- */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
    width: 100%;
    max-width: 1000px;
    align-items: start;
  }
  @media(min-width: 850px) {
    .dashboard-grid { grid-template-columns: 380px 1fr; }
  }

  /* --- ID CARD STYLES --- */
  .id-card {
    background: rgba(20, 20, 22, 0.6);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px; padding: 30px;
    backdrop-filter: blur(12px);
    text-align: center; position: relative;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    z-index: 10;
  }
  .id-card::before {
    content: ""; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, transparent, rgba(var(--accent-gold), 0.8), transparent);
  }
  
  /* Architect Theme */
  .id-card.architect-theme {
    background: linear-gradient(180deg, rgba(20, 20, 22, 0.8), rgba(25, 20, 10, 0.3));
    border-color: rgba(var(--accent-gold), 0.4);
    box-shadow: 0 0 50px rgba(var(--accent-gold), 0.1);
  }
  
  /* Alumni Theme */
  .id-card.alumni-theme {
    background: linear-gradient(160deg, rgba(20, 20, 22, 0.9), rgba(113, 12, 4, 0.15));
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 40px rgba(113, 12, 4, 0.1);
  }
  .id-card.alumni-theme::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
  }

  /* --- NETWORK CARD STYLES --- */
  .network-card {
    background: rgba(20, 20, 22, 0.6);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px; padding: 24px;
    backdrop-filter: blur(12px);
    display: flex; flex-direction: column;
    height: 600px; /* Fixed height for scrolling */
    z-index: 10;
  }
  .network-header {
    display: flex; justify-content: space-between; align-items: center;
    padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
    margin-bottom: 16px;
  }
  .network-title { font-size: 1.2rem; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 8px; }
  
  /* Search Bar */
  .search-wrap { position: relative; width: 100%; margin-bottom: 16px; }
  .search-input {
    width: 100%; padding: 12px 12px 12px 40px;
    background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; color: #fff; font-family: inherit; 
    font-size: 16px; 
  }
  .search-input:focus { outline: none; border-color: rgba(var(--accent-gold), 0.6); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); pointer-events: none; }

  /* User List */
  .user-list {
    flex: 1; overflow-y: auto; padding-right: 4px;
    display: flex; flex-direction: column; gap: 10px;
  }
  /* Custom Scrollbar */
  .user-list::-webkit-scrollbar { width: 4px; }
  .user-list::-webkit-scrollbar-track { background: transparent; }
  .user-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

  .user-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px; border-radius: 8px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
    transition: background 0.2s;
  }
  .user-item:hover { background: rgba(255,255,255,0.05); }
  
  .u-avatar {
    width: 42px; height: 42px; border-radius: 50%;
    background: #151515; border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; color: var(--muted);
    position: relative; flex-shrink: 0;
  }
  .u-info { flex: 1; min-width: 0; }
  .u-name { font-weight: 700; font-size: 0.95rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display:flex; align-items:center; gap:6px;}
  .u-batch { font-size: 0.8rem; color: var(--muted); }
  .u-followers { font-size: 0.75rem; color: rgba(var(--accent-gold), 0.8); font-weight: 600; margin-top: 2px; display:flex; align-items:center; gap:6px; }
  
  /* Badge in List */
  .u-badge {
    font-size: 0.6rem; font-weight: 800; padding: 1px 5px; border-radius: 3px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 4px;
  }
  .u-badge.architect { color: #000; background: rgba(var(--accent-gold), 1); }
  .u-badge.verified { color: rgba(var(--accent-gold), 1); background: rgba(var(--accent-gold), 0.15); border: 1px solid rgba(var(--accent-gold), 0.3); }
  .u-badge.alumni { color: #fff; background: rgba(113, 12, 4, 0.5); border: 1px solid rgba(113, 12, 4, 0.8); }

  .btn-follow {
    padding: 6px 14px; border-radius: 6px; border: none;
    font-weight: 700; font-size: 0.8rem; cursor: pointer;
    background: rgba(255,255,255,0.08); color: var(--text);
    transition: all 0.2s;
  }
  .btn-follow:hover { background: rgba(255,255,255,0.15); }
  .btn-follow.following {
    background: transparent; border: 1px solid rgba(var(--accent-gold), 0.4); color: rgba(var(--accent-gold), 1);
  }

  /* --- GENERAL UI --- */
  .input-group { margin-bottom: 16px; text-align: left; position:relative; }
  label { font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; display: block; }

  .input-box {
    width: 100%; padding: 12px 14px;
    background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px; color: #fff; font-family: inherit; 
    font-size: 16px; 
    transition: border-color 0.2s, box-shadow 0.2s;
    position: relative; z-index: 20;
  }
  /* Padding to prevent text hiding behind eye icon */
  input[type="password"], input[type="text"].password-visible {
      padding-right: 40px; 
  }
  
  .input-box:focus {
    outline: none; border-color: rgba(var(--accent-gold), 0.8);
    box-shadow: 0 0 0 2px rgba(var(--accent-gold), 0.15);
  }
  
  /* Toggle Eye */
  .toggle-pass {
    position: absolute; right: 12px; top: 38px;
    background: none; border: none; padding: 0;
    color: var(--muted); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    z-index: 21; 
  }
  .toggle-pass:hover { color: var(--text); }

  .checkbox-wrap { display: flex; align-items: center; gap: 10px; margin-top: -8px; cursor: pointer; margin-bottom:16px;}
  .checkbox-wrap input { cursor: pointer; accent-color: rgba(var(--accent-gold), 1); width: 16px; height: 16px; }
  .checkbox-wrap span { color: var(--muted); font-size: 0.85rem; }

  .btn-action {
    width: 100%; padding: 14px; border-radius: 8px; border: none;
    font-weight: 800; font-size: 15px; color: #fff;
    background: linear-gradient(180deg, rgba(113,12,4,0.4), rgba(113,12,4,0.6));
    border: 1px solid rgba(113,12,4,0.4); cursor: pointer; transition: 0.2s;
    touch-action: manipulation;
  }
  .btn-action:hover { background: linear-gradient(180deg, rgba(113,12,4,0.6), rgba(113,12,4,0.8)); }
  
  /* --- PROFILE ELEMENTS --- */
  .avatar-large {
    width: 90px; height: 90px; border-radius: 50%;
    background: #111; border: 2px solid rgba(255,255,255,0.1);
    margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;
    font-size: 2rem; color: #333; position: relative;
  }
  
  /* Architect Avatar Special Styling */
  .architect-theme .avatar-large {
    border-color: rgba(var(--accent-gold), 0.8);
    box-shadow: 0 0 30px rgba(var(--accent-gold), 0.2);
  }

  .verified-icon-overlay {
    position: absolute; bottom: 0; right: 0; width: 28px; height: 28px;
    background: #000; border-radius: 50%; border: 2px solid #08090a;
    color: rgba(var(--accent-gold), 1); display: flex; align-items: center; justify-content: center;
    opacity: 0; transform: scale(0.5); transition: all 0.3s;
  }
  .is-verified .verified-icon-overlay { opacity: 1; transform: scale(1); }

  .data-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; align-items:center;}
  .data-val { color: #fff; font-weight: 600; font-family: monospace; text-align: right; }
  .edit-input { background: transparent; border: none; border-bottom: 1px solid rgba(var(--accent-gold), 0.5); color: #fff; font-family: inherit; font-size: 16px; font-weight: 600; text-align: right; width: 140px; padding: 2px 0; outline: none; }

  .hidden { display: none !important; }
  .error-msg { color: #ff6060; font-size: 0.85rem; background: rgba(255,96,96,0.1); padding: 10px; border-radius: 6px; margin-bottom: 12px; display: none; }
  .success-msg { color: gold; font-size: 0.85rem; background: rgba(255,215,0,0.1); padding: 10px; border-radius: 6px; margin-bottom: 12px; display: none; }

  /* Verified Checkmark Small */
  .v-check-sm { width: 14px; height: 14px; margin-left: 4px; }

  /* --- MODAL POPUP --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.4s;
    backdrop-filter: blur(5px);
  }
  .modal-overlay.show { opacity: 1; pointer-events: auto; }
  
  .modal-box {
    background: #0d0e10; border: 1px solid rgba(var(--accent-gold), 0.3);
    width: 90%; max-width: 400px;
    padding: 40px 30px; border-radius: 16px; text-align: center;
    transform: scale(0.9); transition: transform 0.4s;
    box-shadow: 0 0 50px rgba(var(--accent-gold), 0.15);
  }
  .modal-overlay.show .modal-box { transform: scale(1); }

  /* --- MOBILE RESPONSIVE FIX --- */
  @media (max-width: 800px) {
    .wrap {
      /* Ensure content flows from top instead of center to prevent cut-off */
      justify-content: flex-start;
      padding-top: 80px; /* Space for header/back button */
      padding-bottom: 40px;
      padding-left: 20px; /* FIXED: Increased padding to prevent edge clipping */
      padding-right: 20px; /* FIXED: Increased padding to prevent edge clipping */
    }
    .dashboard-grid {
      gap: 16px;
      width: 100%;
    }
    .id-card, .network-card {
      padding: 20px; /* Reduce internal padding for more space */
      width: 100%; /* Ensure full width usage */
    }
    .network-card {
        height: 500px; /* Reduce height slightly for mobile */
    }
  }

</style>
</head>
<body>

<div class="wrap">
  <a href="index.html" style="position:absolute; top:24px; left:24px; color:var(--muted); text-decoration:none; font-weight:600; display:flex; align-items:center; gap:6px; font-size:14px; z-index:20; max-width:fit-content;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back
  </a>

  <!-- LOGIN VIEW -->
  <div id="login-view" class="auth-card">
    <img src="logo.png" style="width:48px; border-radius:50%; margin-bottom:16px;">
    <h1 style="color:#fff; margin-bottom:8px;">Student Portal</h1>
    <p style="color:var(--muted); font-size:0.9rem; margin-bottom:24px;">Login to access your profile.</p>
    <div id="login-error" class="error-msg"></div>
    
    <!-- FIX: Added onsubmit="handleLogin(event)" directly -->
    <form id="login-form" onsubmit="handleLogin(event)">
      <div class="input-group">
        <label>Email Address</label>
        <input type="email" id="log-email" class="input-box" placeholder="" required>
      </div>
      <div class="input-group">
        <label>Password</label>
        <input type="password" id="log-pass" class="input-box" placeholder="" required>
        <button type="button" class="toggle-pass" onclick="togglePassword('log-pass')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
      
      <!-- Forgot Password Link -->
      <div style="text-align:right; margin-bottom:20px; margin-top:-10px;">
          <button type="button" onclick="switchView('forgot')" style="background:none; border:none; color:var(--muted); font-size:0.85rem; cursor:pointer; text-decoration:underline; padding:0;">
              Forgot Password?
          </button>
      </div>

      <button type="submit" id="login-btn" class="btn-action">SECURE LOGIN</button>
    </form>
    <button onclick="switchView('signup')" style="background:none; border:none; color:var(--muted); margin-top:16px; cursor:pointer; text-decoration:underline;">Create Account</button>
  </div>

  <!-- SIGNUP VIEW -->
  <div id="signup-view" class="auth-card hidden">
    <h1 style="color:#fff; margin-bottom:8px;">Join NGHSIANS</h1>
    <p style="color:var(--muted); font-size:0.9rem; margin-bottom:24px;">Register your identity.</p>
    <div id="signup-error" class="error-msg"></div>
    <div id="signup-success" class="success-msg"></div>
    
    <!-- FIX: Added onsubmit="handleSignup(event)" directly -->
    <form id="signup-form" onsubmit="handleSignup(event)">
      <div class="input-group">
        <label>Full Name (Username)</label>
        <input type="text" id="sign-name" class="input-box" placeholder="" required>
      </div>
      <div class="input-group">
        <label>School ID Number</label>
        <input type="text" id="sign-id" class="input-box" placeholder="" required>
      </div>
      <label class="checkbox-wrap">
          <input type="checkbox" id="no-id-check" onchange="toggleIdField()">
          <span>I don't have an ID number</span>
      </label>
      <div class="input-group">
        <label>Batch Year (4 Digits)</label>
        <input type="text" id="sign-batch" class="input-box" placeholder="e.g. 2025" required maxlength="4" pattern="\d{4}" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);">
      </div>
      <div class="input-group">
        <label>Email Address</label>
        <input type="email" id="sign-email" class="input-box" placeholder="" required>
      </div>
      <div class="input-group">
        <label>Create Password</label>
        <input type="password" id="sign-pass" class="input-box" placeholder="" required>
        <button type="button" class="toggle-pass" onclick="togglePassword('sign-pass')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
      <button type="submit" id="sign-btn" class="btn-action">CREATE ACCOUNT</button>
    </form>
    <button onclick="switchView('login')" style="background:none; border:none; color:var(--muted); margin-top:16px; cursor:pointer; text-decoration:underline;">Login</button>
  </div>

  <!-- FORGOT PASSWORD VIEW -->
  <div id="forgot-view" class="auth-card hidden">
    <h1 style="color:#fff; margin-bottom:8px;">Reset Password</h1>
    <p style="color:var(--muted); font-size:0.9rem; margin-bottom:24px;">Enter your email to receive a reset link.</p>
    
    <div id="forgot-error" class="error-msg"></div>
    <div id="forgot-success" class="success-msg"></div>

    <!-- FIX: Added onsubmit="handleForgot(event)" directly -->
    <form id="forgot-form" onsubmit="handleForgot(event)">
        <div class="input-group">
            <label>Email Address</label>
            <input type="email" id="forgot-email" class="input-box" placeholder="" required>
        </div>
        <button type="submit" id="forgot-btn" class="btn-action">SEND RESET LINK</button>
    </form>
    <button onclick="switchView('login')" style="background:none; border:none; color:var(--muted); margin-top:16px; cursor:pointer; text-decoration:underline;">Back to Login</button>
  </div>

  <!-- UPDATE PASSWORD VIEW (Triggered from Email Link) -->
  <div id="update-password-view" class="auth-card hidden">
    <h1 style="color:#fff; margin-bottom:8px;">New Password</h1>
    <p style="color:var(--muted); font-size:0.9rem; margin-bottom:24px;">Secure your account with a new password.</p>
    
    <div id="update-pass-error" class="error-msg"></div>

    <!-- FIX: Added onsubmit="handleUpdatePass(event)" directly -->
    <form id="update-pass-form" onsubmit="handleUpdatePass(event)">
        <div class="input-group">
            <label>New Password</label>
            <input type="password" id="new-password" class="input-box" placeholder="" required>
             <button type="button" class="toggle-pass" onclick="togglePassword('new-password')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
        <button type="submit" id="update-pass-btn" class="btn-action">UPDATE PASSWORD</button>
    </form>
  </div>


  <!-- DASHBOARD VIEW -->
  <div id="dashboard-view" class="dashboard-grid hidden">
    
    <div id="profile-card" class="id-card">
      <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:16px; margin-bottom:20px;">
        <span style="font-size:0.7rem; font-weight:800; color:rgba(var(--accent-gold),0.6); letter-spacing:1px;">IDENTITY</span>
        <span id="header-role" style="font-size:0.7rem; font-weight:800; color:rgba(255,255,255,0.4); letter-spacing:1px;">#STUDENT</span>
      </div>

      <div id="profile-avatar-container" class="avatar-large">
        <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <div class="verified-icon-overlay"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
      </div>

      <h2 id="display-name" style="color:#fff; margin:0; font-size:1.6rem;">Student Name</h2>
      <div id="display-batch" style="color:var(--accent-deep); font-weight:700; font-size:0.9rem; margin-top:4px;">MEMBER</div>

      <div style="margin: 16px 0; cursor:default;" id="follower-stats-wrap">
        <span style="font-size:0.9rem; color:var(--muted);">Followers: </span>
        <span id="my-follower-count" style="color:#fff; font-weight:700; font-size:1rem;">0</span>
      </div>

      <div style="margin-top:30px; text-align:left;">
        <div class="data-row"><span style="color:var(--muted)">ID</span><span id="display-id" class="data-val">---</span></div>
        <div class="data-row"><span style="color:var(--muted)">Batch</span><span id="display-year" class="data-val">---</span></div>
        <div class="data-row"><span style="color:var(--muted)">Email</span><span id="display-email" class="data-val" style="font-size:0.8rem;">---</span></div>
        <div class="data-row" style="border:none"><span style="color:var(--muted)">Status</span><span id="status-text" class="data-val" style="color:var(--muted)">NGHSIANS</span></div>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button onclick="enableEdit()" id="edit-btn" style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:#fff; padding:8px 16px; border-radius:6px; cursor:pointer;">Edit</button>
        <button onclick="saveProfile()" id="save-btn" class="hidden" style="background:rgba(var(--accent-gold),0.8); border:none; padding:8px 16px; border-radius:6px; cursor:pointer; color:#000; font-weight:700;">Save</button>
        <button onclick="cancelEdit()" id="cancel-btn" class="hidden" style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:var(--muted); padding:8px 10px; border-radius:6px; cursor:pointer;">Cancel</button>
      </div>
      <button onclick="handleLogout()" style="background:none; border:none; color:var(--muted); margin-top:12px; font-size:12px; cursor:pointer; text-decoration:underline;">Sign Out</button>
    </div>

    <div class="network-card">
      <div class="network-header">
        <div class="network-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(var(--accent-gold),1)" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          Other NGHSIANS
        </div>
      </div>

      <div class="search-wrap">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="user-search" class="search-input" placeholder="Search name or batch..." onkeyup="filterUsers()">
      </div>

      <div id="network-list" class="user-list">
        <div style="text-align:center; padding:20px; color:var(--muted);">Loading network...</div>
      </div>
    </div>

  </div>

</div>

<div id="verified-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-icon">
      <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
    </div>
    <h2 class="modal-title" id="modal-title">Congratulations!</h2>
    <p id="modal-msg" style="color:#fff; line-height:1.6; margin-bottom:24px;">
      You are now a <strong>Verified NGHSIAN!</strong><br>
      Your profile has been officially authenticated.
    </p>
    <button onclick="closeModal()" class="btn-action" style="width:auto; padding: 10px 30px;">AWESOME</button>
  </div>
</div>

<script>
  /* ===========================
     CONFIG & GLOBALS
     =========================== */
  if (typeof window.supabase === 'undefined') {
      alert("Error: Connection to system failed. Please refresh the page.");
  }

  const SUPABASE_URL = 'https://mctjlcznxpuvtetqnaeh.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jdGpsY3pueHB1dnRldHFuYWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTQzMjQsImV4cCI6MjA3OTA3MDMyNH0.-gVaWU8XHnKIuURzgjpyBZgXNiqLEMC87SfvKMLZ4eg';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const ADMIN_EMAILS = ['nghsians@gmail.com', 'umairhoquechowdhury13@gmail.com'];

  let currentUser = null;
  let currentProfileData = null;
  let allUsers = [];
  const isRecoveryFlow = window.location.hash && (window.location.hash.includes('type=recovery') || window.location.hash.includes('type=magiclink'));

  /* ===========================
     GLOBAL HANDLERS (EXPOSED TO HTML)
     =========================== */

  // 1. LOGIN HANDLER
  async function handleLogin(e) {
      e.preventDefault(); // STOP PAGE RELOAD
      
      const email = document.getElementById('log-email').value;
      const password = document.getElementById('log-pass').value;
      
      const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
      });

      if(error) {
          document.getElementById('login-error').textContent = "Invalid credentials.";
          document.getElementById('login-error').style.display = 'block';
      } else { 
          currentUser = data.user; 
          loadProfile(data.user); 
          loadNetwork(); 
      }
  }

  // 2. SIGNUP HANDLER
  async function handleSignup(e) {
      e.preventDefault(); // STOP PAGE RELOAD
      
      const email = document.getElementById('sign-email').value;
      const password = document.getElementById('sign-pass').value;

      const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password
      });

      if(error) {
          document.getElementById('signup-error').textContent = error.message;
          document.getElementById('signup-error').style.display = 'block';
      } else if(data.user) {
          await supabase.from('verified_profiles').insert([{
              id: data.user.id,
              username: document.getElementById('sign-name').value,
              school_id: document.getElementById('sign-id').value,
              batch_year: document.getElementById('sign-batch').value,
              email: email
          }]);
          alert("Account created! Please login.");
          switchView('login');
      }
  }

  // 3. FORGOT PASSWORD HANDLER
  async function handleForgot(e) {
      e.preventDefault();
      const email = document.getElementById('forgot-email').value;
      const btn = document.getElementById('forgot-btn');
      const errEl = document.getElementById('forgot-error');
      const succEl = document.getElementById('forgot-success');
      
      btn.textContent = "SENDING...";
      errEl.style.display = 'none';
      succEl.style.display = 'none';

      const redirectUrl = window.location.origin + window.location.pathname;

      const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: redirectUrl, 
      });

      if (error) {
          errEl.textContent = error.message;
          errEl.style.display = 'block';
          btn.textContent = "SEND RESET LINK";
      } else {
          succEl.textContent = "Check your email for the reset link!";
          succEl.style.display = 'block';
          btn.textContent = "SENT";
      }
  }

  // 4. UPDATE PASSWORD HANDLER
  async function handleUpdatePass(e) {
      e.preventDefault();
      const newPassword = document.getElementById('new-password').value;
      const btn = document.getElementById('update-pass-btn');
      const errEl = document.getElementById('update-pass-error');

      btn.textContent = "UPDATING...";
      errEl.style.display = 'none';

      const { data, error } = await supabase.auth.updateUser({ password: newPassword });

      if (error) {
          errEl.textContent = error.message;
          errEl.style.display = 'block';
          btn.textContent = "UPDATE PASSWORD";
      } else {
          alert("Password updated successfully!");
          switchView('dashboard');
          loadProfile(data.user);
          loadNetwork();
      }
  }

  // UI HELPERS
  function switchView(view) {
    ['login-view', 'signup-view', 'forgot-view', 'update-password-view', 'dashboard-view'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    const target = document.getElementById(view + '-view');
    if(target) target.classList.remove('hidden');
  }
  
  function toggleIdField() {
    const checkbox = document.getElementById('no-id-check');
    const input = document.getElementById('sign-id');
    if(checkbox.checked) {
      input.value = 'No ID Provided';
      input.disabled = true;
      input.style.opacity = '0.5';
    } else {
      input.value = '';
      input.disabled = false;
      input.style.opacity = '1';
    }
  }
  
  function togglePassword(id) {
    const input = document.getElementById(id);
    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
    input.setAttribute('type', type);
    if (type === 'text') {
        input.classList.add('password-visible');
    } else {
        input.classList.remove('password-visible');
    }
  }

  async function handleLogout() { 
      await supabase.auth.signOut(); 
      window.location.reload(); 
  }
  
  function closeModal() {
      document.getElementById('verified-modal').classList.remove('show');
  }

  /* ===========================
     STARTUP LOGIC
     =========================== */
  async function init() {
    const { data: { session } } = await supabase.auth.getSession();

    if (session && !isRecoveryFlow) {
      currentUser = session.user;
      loadProfile(session.user);
      loadNetwork();
    } else if (session && isRecoveryFlow) {
      currentUser = session.user;
      switchView('update-password'); 
    } else {
      switchView('login');
    }
  }
  
  // Listen for Password Recovery events (User clicks email link)
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'PASSWORD_RECOVERY') {
        switchView('update-password');
        currentUser = session.user; 
    } else if (event === 'SIGNED_OUT') {
        switchView('login');
        currentUser = null;
    }
  });

  // Run Init
  init();


  /* ===========================
     PROFILE LOGIC
     =========================== */
  async function loadProfile(user) {
    if(isRecoveryFlow) return;

    switchView('dashboard');
    document.getElementById('display-email').textContent = user.email;

    const { data, error } = await supabase.from('verified_profiles').select('*').eq('id', user.id).single();
    
    currentProfileData = data || {}; 

    if (currentProfileData) {
        if (!data.email) {
            await supabase.from('verified_profiles').update({ email: user.email }).eq('id', user.id);
        }

        document.getElementById('display-name').textContent = data.username || 'Student';
        document.getElementById('display-id').textContent = data.school_id || '---';
        document.getElementById('display-year').textContent = data.batch_year || '---';
        document.getElementById('my-follower-count').textContent = data.follower_count || 0;

        const card = document.getElementById('profile-card');
        const avatar = document.getElementById('profile-avatar-container');
        const batchTxt = document.getElementById('display-batch');
        const statusTxt = document.getElementById('status-text');
        const headerRole = document.getElementById('header-role');
        const verifiedOverlay = document.querySelector('.verified-icon-overlay');
        
        avatar.classList.remove('is-verified');
        card.classList.remove('architect-theme');
        card.classList.remove('alumni-theme');
        verifiedOverlay.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
        verifiedOverlay.style.color = 'rgba(var(--accent-gold), 1)';

        if (data.role === 'architect') {
             avatar.classList.add('is-verified');
             card.classList.add('architect-theme');
             batchTxt.textContent = 'WEBSITE ARCHITECT';
             batchTxt.style.color = 'rgba(var(--accent-gold), 1)';
             statusTxt.textContent = 'SYSTEM ADMIN';
             statusTxt.style.color = 'rgba(var(--accent-gold), 1)';
             statusTxt.style.fontWeight = '800';
             headerRole.textContent = '#ARCHITECT';

        } else if (data.role === 'elite') {
             avatar.classList.add('is-verified');
             batchTxt.textContent = 'NGHSIANS ELITE';
             batchTxt.style.color = 'rgba(var(--accent-gold), 1)';
             statusTxt.textContent = 'VERIFIED NGHSIANS';
             statusTxt.style.color = 'rgba(var(--accent-gold), 1)';
             statusTxt.style.fontWeight = '800';
             headerRole.textContent = '#VERIFIED';
             
             if (!currentProfileData.notified_of_verification) {
                triggerCelebration('elite');
                await supabase.from('verified_profiles').update({ notified_of_verification: true }).eq('id', user.id);
             }

        } else if (data.role === 'alumni') {
             avatar.classList.add('is-verified');
             card.classList.add('alumni-theme');
             batchTxt.textContent = 'NGHSIANS ALUMNI';
             batchTxt.style.color = '#eef0f2'; // White/Silverish
             statusTxt.textContent = 'ALUMNI ACCOUNT';
             statusTxt.style.color = 'rgba(255,255,255, 0.7)';
             statusTxt.style.fontWeight = '600';
             headerRole.textContent = '#ALUMNI';

             verifiedOverlay.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>';
             verifiedOverlay.style.color = '#fff';

             if (!currentProfileData.notified_of_verification) {
                triggerCelebration('alumni');
                await supabase.from('verified_profiles').update({ notified_of_verification: true }).eq('id', user.id);
             }

        } else {
             batchTxt.textContent = 'NGHSIANS MEMBER';
             statusTxt.textContent = 'NGHSIANS';
             statusTxt.style.color = 'var(--muted)';
             statusTxt.style.fontWeight = '400';
             headerRole.textContent = '#STUDENT';
        }

        if (ADMIN_EMAILS.includes(user.email)) {
            const countEl = document.getElementById('my-follower-count');
            countEl.style.cursor = 'pointer';
            countEl.title = "Click to edit (Admin Only)";
            countEl.onclick = async () => {
                const newCount = prompt("Flex Mode: Enter new follower count:", data.follower_count);
                if (newCount !== null && !isNaN(newCount)) {
                    const { error } = await supabase.from('verified_profiles').update({ follower_count: parseInt(newCount) }).eq('id', user.id);
                    if (!error) {
                         countEl.textContent = newCount;
                         loadNetwork(); 
                    }
                }
            };
        }
    } else {
        document.getElementById('display-name').textContent = 'Update Profile';
        document.getElementById('display-id').textContent = 'N/A';
    }
  }

  /* ===========================
     NETWORK LOGIC
     =========================== */
  async function loadNetwork() {
    const listEl = document.getElementById('network-list');
    
    const { data: profiles, error } = await supabase.from('verified_profiles').select('*');
    if(error) { listEl.innerHTML = '<div style="padding:20px">Failed to load network.</div>'; return; }

    const { data: relationships } = await supabase.from('user_relationships').select('following_id').eq('follower_id', currentUser.id);
    const followingIds = new Set(relationships?.map(r => r.following_id) || []);

    let pinned = [];
    let others = [];

    profiles.forEach(p => {
        if(p.id === currentUser.id) return; 
        if(p.email && ADMIN_EMAILS.includes(p.email)) {
            pinned.push(p);
        } else {
            others.push(p);
        }
    });

    others.sort(() => Math.random() - 0.5);
    allUsers = [...pinned, ...others]; 
    renderUsers(allUsers, followingIds);
  }

  function renderUsers(users, followingSet) {
    const listEl = document.getElementById('network-list');
    listEl.innerHTML = '';

    if(users.length === 0) {
        listEl.innerHTML = '<div style="padding:20px; color:var(--muted); text-align:center">No other students found.</div>';
        return;
    }

    users.forEach(u => {
        const isFollowing = followingSet.has(u.id);
        
        let badgesHtml = '';
        if (u.role === 'architect') {
             badgesHtml += `<span class="u-badge architect">ARCHITECT</span>`;
        }
        if (u.role === 'elite' || u.role === 'architect') {
             badgesHtml += `<span class="u-badge verified">VERIFIED</span>`;
        }
        if (u.role === 'alumni') {
             badgesHtml += `<span class="u-badge alumni">ALUMNI</span>`;
        }
        
        let checkMark = '';
        if (u.role === 'elite' || u.role === 'architect') {
            checkMark = `<svg class="v-check-sm" style="color:rgba(var(--accent-gold),1)" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
        } else if (u.role === 'alumni') {
            checkMark = `<svg class="v-check-sm" style="color:#fff" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>`;
        }
        
        const html = `
        <div class="user-item">
            <div class="u-avatar">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="u-info">
                <div class="u-name">
                  ${u.username || 'Unknown'} 
                  ${checkMark}
                </div>
                <div class="u-batch">Batch: ${u.batch_year || 'N/A'}</div>
                <div class="u-followers">
                    <span id="count-${u.id}">${u.follower_count || 0}</span> followers
                    ${badgesHtml}
                </div>
            </div>
            <button class="btn-follow ${isFollowing ? 'following' : ''}" onclick="toggleFollow('${u.id}', this)">
                ${isFollowing ? 'Following' : 'Follow'}
            </button>
        </div>
        `;
        listEl.insertAdjacentHTML('beforeend', html);
    });
  }

  async function toggleFollow(targetId, btn) {
    const isFollowing = btn.classList.contains('following');
    btn.disabled = true; 

    const countSpan = document.getElementById(`count-${targetId}`);
    let currentCount = parseInt(countSpan.textContent) || 0;

    if(isFollowing) {
        btn.classList.remove('following');
        btn.textContent = 'Follow';
        if (countSpan) countSpan.textContent = Math.max(0, currentCount - 1);

        const { error } = await supabase.from('user_relationships').delete().match({ follower_id: currentUser.id, following_id: targetId });
        
        if(error) {
           btn.classList.add('following');
           btn.textContent = 'Following';
           if (countSpan) countSpan.textContent = currentCount; 
        }

    } else {
        btn.classList.add('following');
        btn.textContent = 'Following';
        if (countSpan) countSpan.textContent = currentCount + 1;

        const { error } = await supabase.from('user_relationships').insert([{ follower_id: currentUser.id, following_id: targetId }]);
        
         if(error) {
           btn.classList.remove('following');
           btn.textContent = 'Follow';
           if (countSpan) countSpan.textContent = currentCount; 
        }
    }
    
    btn.disabled = false;
  }

  function filterUsers() {
      const term = document.getElementById('user-search').value.toLowerCase();
      const items = document.querySelectorAll('.user-item');
      items.forEach(item => {
          const name = item.querySelector('.u-name').textContent.toLowerCase();
          const batch = item.querySelector('.u-batch').textContent.toLowerCase();
          if(name.includes(term) || batch.includes(term)) {
              item.style.display = 'flex';
          } else {
              item.style.display = 'none';
          }
      });
  }

  function enableEdit() {
    document.getElementById('edit-btn').classList.add('hidden');
    document.getElementById('save-btn').classList.remove('hidden');
    document.getElementById('cancel-btn').classList.remove('hidden');

    const nameEl = document.getElementById('display-name');
    const idEl = document.getElementById('display-id');
    const yearEl = document.getElementById('display-year');
    
    const currentName = nameEl.textContent;
    const currentId = idEl.textContent === 'N/A' ? '' : idEl.textContent;
    const currentYear = yearEl.textContent === '----' ? '' : yearEl.textContent;

    nameEl.innerHTML = `<input type="text" id="edit-name-input" class="edit-input" value="${currentName}" style="text-align:center; font-size:1.6rem; width:100%">`;
    idEl.innerHTML = `<input type="text" id="edit-id-input" class="edit-input" value="${currentId}">`;
    yearEl.innerHTML = `<input type="text" id="edit-year-input" class="edit-input" value="${currentYear}" maxlength="4" pattern="\\d{4}" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);">`;
  }

  function cancelEdit() {
     const name = currentProfileData && currentProfileData.username ? currentProfileData.username : 'Student';
     const sid = currentProfileData && currentProfileData.school_id ? currentProfileData.school_id : 'N/A';
     const batch = currentProfileData && currentProfileData.batch_year ? currentProfileData.batch_year : '----';
     
     document.getElementById('display-name').textContent = name;
     document.getElementById('display-id').textContent = sid;
     document.getElementById('display-year').textContent = batch;

     document.getElementById('edit-btn').classList.remove('hidden');
     document.getElementById('save-btn').classList.add('hidden');
     document.getElementById('cancel-btn').classList.add('hidden');
  }

  async function saveProfile() {
      const newName = document.getElementById('edit-name-input').value;
      const newId = document.getElementById('edit-id-input').value;
      const newYear = document.getElementById('edit-year-input').value;
      const saveBtn = document.getElementById('save-btn');

      saveBtn.textContent = 'Saving...';
      
      try {
          const { error } = await supabase.from('verified_profiles').update({
              username: newName,
              school_id: newId,
              batch_year: newYear
          }).eq('id', currentUser.id);

          if (error) throw error;

          if(!currentProfileData) currentProfileData = {};
          currentProfileData.username = newName;
          currentProfileData.school_id = newId;
          currentProfileData.batch_year = newYear;

          document.getElementById('display-name').textContent = newName;
          document.getElementById('display-id').textContent = newId || 'N/A';
          document.getElementById('display-year').textContent = newYear || '----';

          document.getElementById('edit-btn').classList.remove('hidden');
          document.getElementById('save-btn').classList.add('hidden');
          document.getElementById('cancel-btn').classList.add('hidden');
          saveBtn.textContent = 'Save Changes';

      } catch (err) {
          console.error(err);
          alert('Failed to save profile.');
          saveBtn.textContent = 'Save Changes';
      }
  }

  function triggerCelebration(type) {
    const title = document.getElementById('modal-title');
    const msg = document.getElementById('modal-msg');
    const modal = document.getElementById('verified-modal');

    modal.classList.add('show');

    if (type === 'alumni') {
        title.textContent = 'Welcome Home!';
        msg.innerHTML = 'Your <strong>Alumni Status</strong> has been verified.<br>Thank you for your legacy.';
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#710C04', '#ffffff', '#cccccc'] });
    } else {
        title.textContent = 'Congratulations!';
        msg.innerHTML = 'You are now a <strong>Verified NGHSIAN!</strong><br>Your profile has been officially authenticated.';
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#FFF39A', '#710C04', '#ffffff'] });
    }
  }

</script>
</body>
</html>